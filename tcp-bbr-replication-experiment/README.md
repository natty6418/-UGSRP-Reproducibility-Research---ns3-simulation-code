To run this experiment on FABRIC - 

### Get resources on FABRIC

In a Python notebook in the FABRIC Jupyter environment,

1. Configure your FABRIC account

```python
from fabrictestbed_extensions.fablib.fablib import FablibManager as fablib_manager
fablib = fablib_manager() 
conf = fablib.show_config()
```

2. Get a random site, make sure it has cores available

```python
site_name = fablib.get_random_site()
fablib.show_site(site_name)
```

3. Reserve a VM with lots of cores and memory

```python
slice = fablib.new_slice(name='hpc')
slice.add_node(name='hpc', site=site_name, 
                   cores=64, 
                   ram=256, 
                   disk=100, 
                   image='default_ubuntu_22')
slice.submit()
```

Log in the resource over SSH once it is ready.

### Install ns3 on the resource

<!-- TODO: fill in the details -->

```
sudo apt install g++ python3 python3-pip cmake ninja-build git ccache -y
wget https://www.nsnam.org/releases/ns-allinone-3.42.tar.bz2
tar jxf ns-allinone-3.42.tar.bz2
cd ns-allinone-3.42/ 
```

Add the directory to the `PATH`:

```
PATH=$PATH:/home/ubuntu/ns-allinone-3.42/ns-3.42
```

### Install SLURM on the resource

```
sudo apt update -y
sudo apt install slurmd slurmctld -y
```

```
sudo mkdir /etc/slurm-llnl/
sudo chmod 777 /etc/slurm-llnl
sudo mkdir /var/lib/slurm-llnl/
sudo mkdir /var/log/slurm-llnl/
sudo chmod 777 /var/lib/slurm-llnl/
sudo chmod 777 /var/log/slurm-llnl/
```
```
sudo ln -s /etc/slurm-llnl/slurm.conf /etc/slurm/slurm.conf
```

In `/etc/slurm/slurm.conf` - 

```
# slurm.conf file generated by configurator.html.
# Put this file on all nodes of your cluster.
# See the slurm.conf man page for more information.
#
ClusterName=localcluster
SlurmctldHost=localhost
MpiDefault=none
ProctrackType=proctrack/linuxproc
ReturnToService=2
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmctldPort=6817
SlurmdPidFile=/var/run/slurmd.pid
SlurmdPort=6818
SlurmdSpoolDir=/var/lib/slurm-llnl/slurmd
SlurmUser=slurm
StateSaveLocation=/var/lib/slurm-llnl/slurmctld
SwitchType=switch/none
TaskPlugin=task/none
#
# TIMERS
InactiveLimit=0
KillWait=30
MinJobAge=300
SlurmctldTimeout=120
SlurmdTimeout=300
Waittime=0
# SCHEDULING
SchedulerType=sched/backfill
SelectType=select/cons_tres
SelectTypeParameters=CR_Core
#
#AccountingStoragePort=
AccountingStorageType=accounting_storage/none
JobCompType=jobcomp/none
JobAcctGatherFrequency=30
JobAcctGatherType=jobacct_gather/none
SlurmctldDebug=info
SlurmctldLogFile=/var/log/slurm-llnl/slurmctld.log
SlurmdDebug=info
SlurmdLogFile=/var/log/slurm-llnl/slurmd.log
#
# COMPUTE NODES
NodeName=hpc CPUs=64 Boards=1 SocketsPerBoard=64 CoresPerSocket=1 ThreadsPerCore=1 RealMemory=386748 State=Unknown
PartitionName=LocalQ Nodes=ALL Default=YES MaxTime=INFINITE State=UP

## GRES
GresTypes=gpu,mps
DebugFlags=CPU_Bind,gres
```
Then start with

```
sudo service slurmctld restart && sudo service slurmd restart
```

Check with 

```
sinfo
```
the `STATE` should be `idle`.

### Get simulation code

1. Clone this repo:

```
git clone https://github.com/natty6418/TCP-ns3
```

2. Put it in the scratch directory:

```
cp -R TCP-ns3/tcp-bbr-replication-experiment ns-allinone-3.42/ns-3.42/scratch/tcp-bbr-repro
```

3. Build the simulation:

```
ns3 build
```
